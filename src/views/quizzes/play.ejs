<% layout('layout') -%>
<h1 class="mb-3"><%= quiz.title %></h1>
<form id="quiz-form" class="card p-3">
  <% questions.forEach((q, idx) => { %>
    <div class="mb-3 q-item" data-index="<%= idx %>" data-qid="<%= q.id %>" data-type="<%= q.type %>" style="display: <%= idx === 0 ? 'block' : 'none' %>;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label fw-bold mb-0">Q<%= idx + 1 %> of <%= questions.length %>: <%= q.prompt %></label>
      </div>
      <div class="q-choices">
        <% (choices[q.id] || []).forEach(ch => { %>
          <div class="form-check">
            <input class="form-check-input" type="<%= q.type === 'multiple' ? 'checkbox' : 'radio' %>" name="answers[<%= q.id %>]" value="<%= ch.id %>" id="c-<%= ch.id %>" data-correct="<%= ch.is_correct %>">
            <label class="form-check-label" for="c-<%= ch.id %>"><%= ch.text %></label>
          </div>
        <% }) %>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-outline-secondary" type="button" id="btn-prev">Previous</button>
        <button class="btn btn-primary" type="submit" id="btn-submit">Submit</button>
        <button class="btn btn-success" type="button" id="btn-next" disabled>Next</button>
      </div>
      <div class="mt-3" id="feedback"></div>
    </div>
  <% }) %>
  <div id="final" class="mt-3" style="display:none;"></div>
  </form>

<script>
const items = Array.from(document.querySelectorAll('.q-item'));
let current = 0;
const answers = {};

function show(idx) {
  items.forEach((el, i) => el.style.display = i === idx ? 'block' : 'none');
}

function evaluateCurrent() {
  const item = items[current];
  const qid = item.getAttribute('data-qid');
  const type = item.getAttribute('data-type');
  const inputs = Array.from(item.querySelectorAll('input.form-check-input'));
  const selected = inputs.filter(i => i.checked).map(i => Number(i.value)).sort((a,b)=>a-b);
  const correct = inputs.filter(i => i.dataset.correct === '1').map(i => Number(i.value)).sort((a,b)=>a-b);
  const feedback = item.querySelector('#feedback');
  if (selected.length === 0) {
    feedback.innerHTML = `<div class="alert alert-warning">Please select an answer.</div>`;
    return false;
  }
  let isCorrect;
  if (type === 'single') {
    isCorrect = selected.length === 1 && correct.includes(selected[0]);
  } else {
    isCorrect = JSON.stringify(selected) === JSON.stringify(correct);
  }
  answers[qid] = type === 'single' ? selected[0] : selected;
  if (isCorrect) {
    feedback.innerHTML = `<div class="alert alert-success">Correct!</div>`;
  } else {
    const labels = inputs.filter(i => i.dataset.correct === '1').map(i => item.querySelector(`label[for="${i.id}"]`).textContent.trim());
    feedback.innerHTML = `<div class="alert alert-danger">Incorrect. Correct answer(s): ${labels.join(', ')}</div>`;
  }
  item.querySelector('#btn-next').disabled = false;
  return true;
}

function finishQuiz() {
  const payload = { answers };
  fetch(`/api/quizzes/<%= quiz.id %>/submit`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
  }).then(r => r.json()).then(data => {
    document.getElementById('final').style.display = 'block';
    document.getElementById('final').innerHTML = `<div class="alert alert-info">Final Score: ${data.score} / ${data.total}</div>`;
  }).catch(() => {
    document.getElementById('final').style.display = 'block';
    document.getElementById('final').innerHTML = `<div class="alert alert-warning">Could not submit score. Please try again.</div>`;
  });
}

document.getElementById('quiz-form').addEventListener('submit', (e) => {
  e.preventDefault();
  evaluateCurrent();
});

document.getElementById('quiz-form').addEventListener('click', (e) => {
  const target = e.target;
  const item = items[current];
  if (target && target.id === 'btn-prev') {
    if (current > 0) { current -= 1; show(current); }
  }
  if (target && target.id === 'btn-next') {
    if (current < items.length - 1) {
      current += 1; show(current);
    } else {
      finishQuiz();
    }
  }
});

show(current);
</script>

